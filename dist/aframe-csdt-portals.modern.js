import*as e from"yjs";var t;!function(e){function t(s){if(n[s])return n[s].exports;var i=n[s]={exports:{},id:s,loaded:!1};return e[s].call(i.exports,i,i.exports,t),i.loaded=!0,i.exports}var n={};t.m=e,t.c=n,t.p="",t(0)}([function(e,t){if("undefined"==typeof AFRAME)throw new Error("Component attempted to register before AFRAME was available.");var n={childList:!0,attributes:!0,subtree:!0};AFRAME.registerComponent("aabb-collider",{schema:{collideNonVisible:{default:!1},debug:{default:!1},enabled:{default:!0},interval:{default:80},objects:{default:""}},init:function(){this.centerDifferenceVec3=new THREE.Vector3,this.clearedIntersectedEls=[],this.closestIntersectedEl=null,this.boundingBox=new THREE.Box3,this.boxCenter=new THREE.Vector3,this.boxHelper=new THREE.BoxHelper,this.boxMax=new THREE.Vector3,this.boxMin=new THREE.Vector3,this.hitClosestClearEventDetail={},this.hitClosestEventDetail={},this.intersectedEls=[],this.objectEls=[],this.newIntersectedEls=[],this.prevCheckTime=void 0,this.previousIntersectedEls=[],this.setDirty=this.setDirty.bind(this),this.observer=new MutationObserver(this.setDirty),this.dirty=!0,this.hitStartEventDetail={intersectedEls:this.newIntersectedEls}},play:function(){this.observer.observe(this.el.sceneEl,n),this.el.sceneEl.addEventListener("object3dset",this.setDirty),this.el.sceneEl.addEventListener("object3dremove",this.setDirty)},remove:function(){this.observer.disconnect(),this.el.sceneEl.removeEventListener("object3dset",this.setDirty),this.el.sceneEl.removeEventListener("object3dremove",this.setDirty)},tick:function(e){var t,n,s,i,o=this.boundingBox,r=this.centerDifferenceVec3,l=this.clearedIntersectedEls,a=this.intersectedEls,c=this.el,d=this.newIntersectedEls,h=this.objectEls,u=this.prevCheckTime,m=this.previousIntersectedEls;if(this.data.enabled&&!(u&&e-u<this.data.interval)){for(this.prevCheckTime=e,this.dirty&&this.refreshObjects(),o.setFromObject(c.object3D),this.boxMin.copy(o.min),this.boxMax.copy(o.max),o.getCenter(this.boxCenter),this.data.debug&&(this.boxHelper.setFromObject(c.object3D),this.boxHelper.parent||c.sceneEl.object3D.add(this.boxHelper)),function(e,t){var n;for(e.length=0,n=0;n<t.length;n++)e[n]=t[n]}(m,a),a.length=0,i=0;i<h.length;i++)h[i]!==this.el&&(this.data.collideNonVisible||h[i].getAttribute("visible")?this.isIntersecting(h[i])&&a.push(h[i]):this.data.debug&&(t=h[i].object3D.boxHelper)&&(c.sceneEl.object3D.remove(t),h[i].object3D.boxHelper=null));for(d.length=0,i=0;i<a.length;i++)-1===m.indexOf(a[i])&&d.push(a[i]);for(l.length=0,i=0;i<m.length;i++)-1===a.indexOf(m[i])&&(m[i].hasAttribute("aabb-collider")||m[i].emit("hitend"),l.push(m[i]));for(i=0;i<d.length;i++)d[i]!==this.el&&(d[i].hasAttribute("aabb-collider")||d[i].emit("hitstart"));for(i=0;i<a.length;i++)a[i]!==this.el&&(r.copy(a[i].object3D.boundingBoxCenter).sub(this.boxCenter),(void 0===n||r.length()<n)&&(n=r.length(),s=a[i]));!a.length&&this.closestIntersectedEl?(this.hitClosestClearEventDetail.el=this.closestIntersectedEl,this.closestIntersectedEl.emit("hitclosestclear"),this.closestIntersectedEl=null,c.emit("hitclosestclear",this.hitClosestClearEventDetail)):s!==this.closestIntersectedEl&&(this.closestIntersectedEl&&(this.hitClosestClearEventDetail.el=this.closestIntersectedEl,this.closestIntersectedEl.emit("hitclosestclear",this.hitClosestClearEventDetail)),s&&(s.emit("hitclosest"),this.closestIntersectedEl=s,this.hitClosestEventDetail.el=s,c.emit("hitclosest",this.hitClosestEventDetail))),l.length&&c.emit("hitend"),d.length&&c.emit("hitstart",this.hitStartEventDetail)}},isIntersecting:function(){var e=new THREE.Box3;return function(t){var n,s;return e.setFromObject(t.object3D),this.data.debug&&(t.object3D.boxHelper||(t.object3D.boxHelper=new THREE.BoxHelper(t.object3D,new THREE.Color(Math.random(),Math.random(),Math.random())),t.sceneEl.object3D.add(t.object3D.boxHelper)),t.object3D.boxHelper.setFromObject(t.object3D)),n=e.min,s=e.max,t.object3D.boundingBoxCenter=t.object3D.boundingBoxCenter||new THREE.Vector3,e.getCenter(t.object3D.boundingBoxCenter),this.boxMin.x<=s.x&&this.boxMax.x>=n.x&&this.boxMin.y<=s.y&&this.boxMax.y>=n.y&&this.boxMin.z<=s.z&&this.boxMax.z>=n.z}}(),setDirty:function(){this.dirty=!0},refreshObjects:function(){var e=this.data;this.objectEls=e.objects?this.el.sceneEl.querySelectorAll(e.objects):this.el.sceneEl.children,this.dirty=!1}})}]),t=function(e){function t(e,t){e.prototype=Object.create(t.prototype),e.prototype.constructor=e,n(e,t)}function n(e,t){return(n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}var s=function(e){function n(t){var n;return(n=e.call(this)||this).element=t||document.createElement("div"),n.element.style.position="absolute",n.element.style.pointerEvents="auto",n.addEventListener("removed",function(){this.traverse(function(e){e.element instanceof Element&&null!==e.element.parentNode&&e.element.parentNode.removeChild(e.element)})}),n}return t(n,e),n.prototype.copy=function(t,n){return e.prototype.copy.call(this,t,n),this.element=t.element.cloneNode(!0),this},n}(THREE.Object3D);s.prototype.isCSS3DObject=!0,function(e){function n(t){var n;return(n=e.call(this,t)||this).rotation2D=0,n}return t(n,e),n.prototype.copy=function(t,n){return e.prototype.copy.call(this,t,n),this.rotation2D=t.rotation2D,this},n}(s).prototype.isCSS3DSprite=!0;var i=new THREE.Matrix4,o=new THREE.Matrix4,r=function(){var e,t,n,s,r=this,l={camera:{fov:0,style:""},objects:new WeakMap},a=document.createElement("div");a.style.overflow="hidden",this.domElement=a;var c=document.createElement("div");function d(e){return Math.abs(e)<1e-10?0:e}function h(e){var t=e.elements;return"matrix3d("+d(t[0])+","+d(-t[1])+","+d(t[2])+","+d(t[3])+","+d(t[4])+","+d(-t[5])+","+d(t[6])+","+d(t[7])+","+d(t[8])+","+d(-t[9])+","+d(t[10])+","+d(t[11])+","+d(t[12])+","+d(-t[13])+","+d(t[14])+","+d(t[15])+")"}function u(e){var t=e.elements;return"translate(-50%,-50%)matrix3d("+d(t[0])+","+d(t[1])+","+d(t[2])+","+d(t[3])+","+d(-t[4])+","+d(-t[5])+","+d(-t[6])+","+d(-t[7])+","+d(t[8])+","+d(t[9])+","+d(t[10])+","+d(t[11])+","+d(t[12])+","+d(t[13])+","+d(t[14])+","+d(t[15])+")"}function m(e,t,n,s){if(e.isCSS3DObject){var a;e.onBeforeRender(r,t,n),e.isCSS3DSprite?(i.copy(n.matrixWorldInverse),i.transpose(),0!==e.rotation2D&&i.multiply(o.makeRotationZ(e.rotation2D)),i.copyPosition(e.matrixWorld),i.scale(e.scale),i.elements[3]=0,i.elements[7]=0,i.elements[11]=0,i.elements[15]=1,a=u(i)):a=u(e.matrixWorld);var d=e.element,h=l.objects.get(e);void 0!==h&&h.style===a||(d.style.transform=a,l.objects.set(e,{style:a})),d.style.display=e.visible?"":"none",d.parentNode!==c&&c.appendChild(d),e.onAfterRender(r,t,n)}for(var p=0,b=e.children.length;p<b;p++)m(e.children[p],t,n)}c.style.transformStyle="preserve-3d",c.style.pointerEvents="none",a.appendChild(c),this.getSize=function(){return{width:e,height:t}},this.render=function(e,t){var i,o,r=t.projectionMatrix.elements[5]*s;l.camera.fov!==r&&(a.style.perspective=t.isPerspectiveCamera?r+"px":"",l.camera.fov=r),!0===e.autoUpdate&&e.updateMatrixWorld(),null===t.parent&&t.updateMatrixWorld(),t.isOrthographicCamera&&(i=-(t.right+t.left)/2,o=(t.top+t.bottom)/2);var u=(t.isOrthographicCamera?"scale("+r+")translate("+d(i)+"px,"+d(o)+"px)"+h(t.matrixWorldInverse):"translateZ("+r+"px)"+h(t.matrixWorldInverse))+"translate("+n+"px,"+s+"px)";l.camera.style!==u&&(c.style.transform=u,l.camera.style=u),m(e,e,t)},this.setSize=function(i,o){n=(e=i)/2,s=(t=o)/2,a.style.width=i+"px",a.style.height=o+"px",c.style.width=i+"px",c.style.height=o+"px"}},l=100,a=function(){function e(e,t){this.websurfaceEntity=t,this.enabled=!0,this.cssRenderer=new r,this.domElement=this.cssRenderer.domElement,this.domElement.style.position="fixed",this.domElement.style.zIndex="-2",this.cssCamera=new THREE.PerspectiveCamera(e.fov,e.aspect,e.near*l,e.far*l),this.camera=e,this.cssScene=new THREE.Scene,this.update=this.update.bind(this)}var t=e.prototype;return t.setSize=function(e,t){this.cssRenderer.setSize(e,t),this.cssCamera.aspect=e/t,this.cssCamera.updateProjectionMatrix()},t.update=function(){this.camera.getWorldPosition(this.cssCamera.position),this.cssCamera.position.multiplyScalar(l),this.camera.getWorldQuaternion(this.cssCamera.quaternion),this.cssRenderer.render(this.cssScene,this.cssCamera)},e}(),c=function(e){function n(t,n,i,o,r){var a,c=(void 0===r?{}:r).elementWidth,d=void 0===c?1280:c,h=new THREE.PlaneGeometry(i,o),u=new THREE.MeshBasicMaterial({opacity:0,blending:THREE.NoBlending,side:THREE.DoubleSide,color:new THREE.Color(0,0,0)});return(a=e.call(this,h,u)||this).context=t,a.domElement=n,a.aspectRatio=o/i,a.elementWidth=d,a.elementHeight=a.elementWidth*a.aspectRatio,a.width=i,a.height=o,a.resizeElement(),a.cssObject=new s(a.domElement),a.cssObject.scale.multiplyScalar(l/(a.elementWidth/a.width)),a.cssObjectInitialScale=a.cssObject.scale,a.size=new THREE.Vector3,a.box=new THREE.Box3,a.addEventListener("added",a.handleAdded),a.addEventListener("removed",a.handleRemoved),a.update=a.update.bind(function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(a)),a}t(n,e);var i=n.prototype;return i.handleAdded=function(){this.context.cssScene.add(this.cssObject)},i.handleRemoved=function(){this.context.cssScene.remove(this.cssObject)},i.resizeElement=function(){this.domElement.style.width=this.elementWidth+"px",this.domElement.style.height=this.elementHeight+"px"},i.setElement=function(e){this.domElement.parentNode&&this.domElement.parentNode.removeChild(this.domElement),this.domElement=e,this.cssObject.element=e,this.resizeElement()},i.update=function(e){this.cssObject.quaternion.copy(e.quaternion),this.cssObject.position.copy(e.position).multiplyScalar(l),this.box.setFromObject(this).getSize(this.size);var t=e.scale;this.oldScaleFactor!=t&&(this.oldScaleFactor=t,this.cssObject.scale.set(this.cssObjectInitialScale.x,this.cssObjectInitialScale.y,this.cssObjectInitialScale.z),this.cssObject.scale.multiply(t)),this.cssObject.visible=e.visible},i.dispose=function(){this.removeEventListener("added",this.handleAdded),this.removeEventListener("removed",this.handleRemoved),this.domElement.remove(),this.geometry.dispose(),this.material.dispose()},n}(THREE.Mesh),d=AFRAME.registerComponent("websurface",{schema:{url:{default:"https://aframe.io"},width:{default:1},height:{default:.75},isInteractable:{default:!0},frameSkips:{default:1},autoSceneStyling:{default:!0}},init:function(){var e=this.el,t=this.data;1==t.autoSceneStyling&&(e.sceneEl.style.position="absolute",e.sceneEl.style.zIndex="1"),1==t.isInteractable&&(t.mouseHasLeftScreen=!0,e.setAttribute("geometry","primitive:plane; width:"+t.width+"; height:"+t.height+";"),e.addEventListener("click",function(){0!=t.mouseHasLeftScreen&&(document.exitPointerLock(),e.sceneEl.style.zIndex="-1",t.mouseHasLeftScreen=!1)}),e.addEventListener("mouseenter",function(){t.context.domElement.style.zIndex="0"}),e.addEventListener("mouseleave",function(){t.context.domElement.style.zIndex="-2",t.mouseHasLeftScreen=!0})),e.addEventListener("cam-loaded",function(){var n=document.createElement("iframe");n.setAttribute("src",t.url),n.style.border="none";var s=new a(e.sceneEl.camera,e);s.setSize(window.innerWidth,window.innerHeight),document.body.appendChild(s.domElement);var i=new c(s,n,t.width,t.height);if(e.object3D.add(i),1==t.isInteractable){var o=document.createElement("div");o.style.position="fixed",o.style.top="0",o.style.width="100%",o.style.height="100%",o.style.zIndex="-1",s.domElement.appendChild(o),o.addEventListener("click",function(){e.sceneEl.style.zIndex=1})}this.websurface_iframe=n,this.css3d_context=s,t.context=s,t.element=i,window.addEventListener("resize",function(){s.setSize(window.innerWidth,window.innerHeight)})}),t.frames=0,t.isCamLoaded=!1},tick:function(){var e=this.el,t=this.data;if(1!=t.isPaused)if(0!=t.isCamLoaded){var n=t.context,s=t.element;t.frames%t.frameSkips==0&&(n&&n.update(),s&&s.update(e.object3D)),t.frames++}else e.sceneEl.camera&&(this.el.emit("cam-loaded"),t.isCamLoaded=!0)},pause:function(){this.data.isPaused=!0},play:function(){this.data.isPaused=!1}});e.component=d},"object"==typeof exports&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(self.aframeWebsurfaces={});class n extends class{constructor(){this.version="0.1.0",this.ydoc=new e.Doc,document.addEventListener("CSDT-y-update",t=>{e.applyUpdate(this.ydoc,t.detail)})}}{constructor(e){super(),this.iframe=e,this.ydoc.on("update",(e,t,n,s)=>{const i=new CustomEvent("CSDT-y-update",{detail:e});this.iframe.contentDocument.dispatchEvent(i)})}checkSupport(){return new Promise((e,t)=>{window.document.addEventListener("CSDT-response-check-support",t=>e(t.detail),{once:!0});const n=new CustomEvent("CSDT-check-support");this.iframe.contentDocument.dispatchEvent(n)})}openPortal(e=!1,t=!1){return new Promise((e,n)=>{window.document.addEventListener("CSDT-response-portal-open",t=>e(t.detail),{once:!0});const s={recievesThree:hasThreeScene,sendsThree:t},i=new CustomEvent("CSDT-portal-open",{detail:s});this.iframe.contentDocument.dispatchEvent(i)})}}AFRAME.registerComponent("web-portal",{schema:{url:{default:"https://aframe.io"},text:{default:""},width:{default:1.5},height:{default:2.4},frameWidth:{default:.15},enableFrame:{default:!0},enableWebsurface:{default:!0},enableReturnButton:{default:!1},enableCSDT:{default:!0}},init:function(){const e=this.el,t=this.data,s=this.el.sceneEl;t.siteSendsThree=!1,t.siteRecievesThree=!1,t.has_iframe_loaded=!1,e.object3D.position.y+=t.height/2;const i=document.createElement("a-text");if(i.setAttribute("value",t.text),i.setAttribute("position",`0 ${.5*t.height+.25+t.frameWidth} 0`),i.setAttribute("align","center"),i.setAttribute("side","double"),e.appendChild(i),t.titleEl=i,1==t.enableFrame){const n=t.frameWidth,s=t.width,i=t.height,o=document.createElement("a-box");o.setAttribute("position",(s+n)/2+" 0 0"),o.setAttribute("scale",`${n} ${i} ${n}`),e.appendChild(o);const r=document.createElement("a-box");r.setAttribute("position",-(s+n)/2+" 0 0"),r.setAttribute("scale",`${n} ${i} ${n}`),e.appendChild(r);const l=document.createElement("a-box");l.setAttribute("position",`0 ${(i+n)/2} 0`),l.setAttribute("scale",`${s+2*n} ${n} ${n}`),e.appendChild(l);const a=document.createElement("a-box");a.setAttribute("position","0 0 "+(-n/4-.01)),a.setAttribute("scale",`${s+2*n} ${i+2*n} ${n/2}`),e.appendChild(a)}if(s.camera){const t=s.camera.el;t.id||(t.id="web-portal-cam-tag"),e.setAttribute("aabb-collider",{objects:`#${t.id}`})}else e.sceneEl.addEventListener("loaded",()=>{const t=s.camera.el;t.id||(t.id="web-portal-cam-tag"),e.setAttribute("aabb-collider",{objects:`#${t.id}`})});if("parent"==t.url)e.setAttribute("geometry",{primitive:"plane",width:t.width,height:t.height}),e.setAttribute("material",{color:"#c8c"}),e.addEventListener("hitstart",function(){document.exitPointerLock(),window.CSDT.portalReturn()});else if(1==t.enableCSDT);else{if(1==t.enableWebsurface)e.setAttribute("websurface",{url:t.url,width:t.width,height:t.height,isInteractable:!1});else{e.setAttribute("geometry",{primitive:"plane",width:t.width,height:t.height}),e.setAttribute("material",{color:"#c8c"});const n=document.createElement("iframe");n.src=t.url,document.body.appendChild(n),n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.overflow="none",n.style.zIndex=10,n.style.display="none",e.websurface_iframe=n}if(1==t.enableReturnButton){const e=t.returnButton=document.createElement("button");e.className="web-portal-overlay-button",e.innerHTML="return";const n="\n      .web-portal-overlay-button {\n        position: fixed;\n        top: .5em;\n        left: .5em;\n\n        cursor: pointer;\n        color: white;\n        box-shadow: 1px 1px 1px 1px #000000;\n        background-color: transparent;\n        border-radius: 5px;\n        border: 2px solid white;\n        \n        font-family: Arial;\n        font-size: 1em;\n        font-weight: bold;\n        text-shadow: 2px 2px 1px #000000;\n        padding: 0.25em 0.5em;\n\n        z-index: 20;\n      }\n      \n      button:hover {\n        color: lightgrey;\n        border-color: lightgrey;\n      }",s=document.createElement("style");s.styleSheet?s.styleSheet.cssText=n:s.appendChild(document.createTextNode(n)),e.appendChild(s),document.body.appendChild(e),e.style.display="none",e.onclick=()=>{this.returnFromPortal()}}1==t.enableCSDT&&e.addEventListener("iframe loaded",()=>{e.websurface_iframe.addEventListener("load",()=>{const s=this.CSDT=new n(e.websurface_iframe);s.checkSupport().then(()=>{s.openPortal(!0,!0,!0).then(e=>{console.log(e),1==e.sendsThree&&(t.siteSendsThree=!0),1==e.recievesThree&&(t.siteRecievesThree=!0)})}),document.addEventListener("CSDT-portal-return",()=>{this.returnFromPortal()})})}),e.addEventListener("hitstart",function(){if(1==t.enableWebsurface){e.components.websurface.pause();const n=e.websurface_iframe,s=e.css3d_context.domElement;t.style_iframe=n.style.cssText,t.style_context=s.style.cssText,t.style_contextChild=s.children[0].style.cssText,n.style="",s.style="",s.children[0].style="",n.style.position="fixed",n.style.top="0",n.style.left="0",n.style.width="100%",n.style.height="100%",n.style.overflow="none"}s.style.display="none",e.websurface_iframe&&(e.websurface_iframe.style.display="block"),t.returnButton&&(t.returnButton.style.display="block"),document.exitPointerLock()})}},returnFromPortal:function(){const e=this.el,t=this.data,n=this.el.sceneEl;if(1==t.enableWebsurface){const n=e.css3d_context.domElement;e.websurface_iframe.style=t.style_iframe,n.style=t.style_context,n.children[0].style.cssText=t.style_contextChild,e.components.websurface.play()}const s=n.camera.el,i=new THREE.Vector3;e.object3D.getWorldPosition(i),i.y=s.object3D.position.y;const o=new THREE.Vector3;e.object3D.getWorldDirection(o).multiplyScalar(1.5);const r=new THREE.Vector3;if(r.copy(i),r.add(o),s.object3D.position.x=r.x,s.object3D.position.z=r.z,s.components["look-controls"]){s.setAttribute("look-controls",{enabled:!1});const e=new THREE.Vector3;s.object3D.getWorldPosition(e);const t=new THREE.Vector3;t.subVectors(e,i).add(e),s.object3D.lookAt(t),s.object3D.updateMatrix();const n=s.getAttribute("rotation");s.components["look-controls"].pitchObject.rotation.x=THREE.Math.degToRad(n.x),s.components["look-controls"].yawObject.rotation.y=THREE.Math.degToRad(n.y),s.setAttribute("look-controls",{enabled:!0})}n.style.display="block",t.returnButton&&(t.returnButton.style.display="none")},update:function(){const e=this.data;e.titleEl.setAttribute("value",e.text)},tick:function(){const e=this.el,t=this.data;if(0==t.has_iframe_loaded&&e.websurface_iframe&&e.websurface_iframe.contentDocument&&(t.has_iframe_loaded=!0,e.emit("iframe loaded")),1==t.siteRecievesThree){const t=e.sceneEl.object3D.clone();t.children=t.children.filter(e=>{}),Math.random()>.99&&console.log(t.children)}}});
//# sourceMappingURL=aframe-csdt-portals.modern.js.map
